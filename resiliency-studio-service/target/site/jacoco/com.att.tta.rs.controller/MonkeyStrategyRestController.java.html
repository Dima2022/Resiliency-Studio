<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MonkeyStrategyRestController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">resiliency-studio-service</a> &gt; <a href="index.source.html" class="el_package">com.att.tta.rs.controller</a> &gt; <span class="el_source">MonkeyStrategyRestController.java</span></div><h1>MonkeyStrategyRestController.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 *   BSD License
 *    
 *   Copyright (c) 2017, AT&amp;T Intellectual Property.  All other rights reserved.
 *    
 *   Redistribution and use in source and binary forms, with or without modification, are permitted
 *   provided that the following conditions are met:
 *    
 *   1. Redistributions of source code must retain the above copyright notice, this list of conditions
 *      and the following disclaimer.
 *   2. Redistributions in binary form must reproduce the above copyright notice, this list of
 *      conditions and the following disclaimer in the documentation and/or other materials provided
 *      with the distribution.
 *   3. All advertising materials mentioning features or use of this software must display the
 *      following acknowledgement:  This product includes software developed by the AT&amp;T.
 *   4. Neither the name of AT&amp;T nor the names of its contributors may be used to endorse or
 *      promote products derived from this software without specific prior written permission.
 *    
 *   THIS SOFTWARE IS PROVIDED BY AT&amp;T INTELLECTUAL PROPERTY ''AS IS'' AND ANY EXPRESS OR
 *   IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 *   MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
 *   SHALL AT&amp;T INTELLECTUAL PROPERTY BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 *   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 *   PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  LOSS OF USE, DATA, OR PROFITS;
 *   OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 *   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
 *   ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
 *   DAMAGE.
 *******************************************************************************/
package com.att.tta.rs.controller;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.util.UriComponentsBuilder;

import com.att.tta.rs.model.Application;
import com.att.tta.rs.model.FailurePoint;
import com.att.tta.rs.model.MonkeyStrategy;
import com.att.tta.rs.model.MonkeyType;
import com.att.tta.rs.service.ApplicationService;
import com.att.tta.rs.service.MonkeyStrategyService;
import com.att.tta.rs.service.TeamUserService;
import com.att.tta.rs.util.AppUtil;
import com.att.tta.rs.util.MessageWrapper;
import com.google.common.collect.Lists;

import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;

/**
 * This Class provides certain REST APIs to perform CRUD operations on Monkey
 * Strategy repository.
 * 
 * @author mb6872
 *
 */
@RestController
@Api(value = &quot;Monkey Strategy Rest Controller&quot;, description = &quot;This REST controller provides REST APIs for performing CRUD Operation on Monkey Strategy Repository&quot;)
<span class="fc" id="L78">public class MonkeyStrategyRestController {</span>

<span class="fc" id="L80">	private static final Logger logger = LoggerFactory.getLogger(MonkeyStrategyRestController.class);</span>

	/**
	 * instance of {@link MonkeyStrategyService}
	 */
	@Autowired
	MonkeyStrategyService monkeyStrategyService;

	@Autowired
	ApplicationService applicationService;

	/**
	 * instance of {@link TeamUserService}
	 */
	@Autowired
	TeamUserService userDetailsService;

	/**
	 * This API returns list of all Monkey Strategies objects available in
	 * Monkey Strategy Repository.
	 * 
	 * @return ResponseEntity&lt;Object&gt;
	 */
	@ApiOperation(value = &quot;This API returns all Monkey Strategy Objects present in Elastic Search&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;Returned all Monkey Strategy Objects&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/&quot;, method = RequestMethod.GET)
	public ResponseEntity&lt;Object&gt; listAllMonkeyStrategies() {
<span class="fc" id="L109">		List&lt;MonkeyStrategy&gt; monkeyStrategies = Lists.newArrayList(monkeyStrategyService.findAllMonkeyStrategies());</span>
<span class="pc bpc" id="L110" title="1 of 4 branches missed.">		if (monkeyStrategies == null || monkeyStrategies.isEmpty()) {</span>
<span class="fc" id="L111">			final String error = &quot; No monkeyStrategies found &quot;;</span>
<span class="fc" id="L112">			logger.debug(error);</span>
<span class="fc" id="L113">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L114">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L116">		return new ResponseEntity&lt;&gt;(monkeyStrategies, HttpStatus.OK);</span>
	}

	/**
	 * This API returns all monkeyStrategies for current user Team
	 * 
	 * @param request
	 * @return list of AllMonkeyStrategy
	 */
	@ApiOperation(value = &quot;This API returns list of all Monkey Strategy objects present in Elastic Search for given team&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;Returned all Monkey Strategy Objects for given team&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given team&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/team-strategies/&quot;, method = RequestMethod.GET, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; listAllMonkeyStrategy(HttpServletRequest request) {
<span class="fc" id="L131">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L132">		List&lt;MonkeyStrategy&gt; monkeyStrategies = Lists.newArrayList(monkeyStrategyService.findAllForTeam(teamName));</span>

<span class="pc bpc" id="L134" title="1 of 4 branches missed.">		if (monkeyStrategies == null || monkeyStrategies.isEmpty()) {</span>
<span class="fc" id="L135">			final String error = &quot;No monkeyStrategies found for Team &quot; + teamName;</span>
<span class="fc" id="L136">			logger.debug(error);</span>
<span class="fc" id="L137">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L138">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L140">		return new ResponseEntity&lt;&gt;(monkeyStrategies, HttpStatus.OK);</span>
	}

	/**
	 * This API returns All monkeyTypes
	 * 
	 * @param request
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns List of Monkey Type&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;Returned Monkey Type values&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;The resource trying to reach is not found&quot;) })
	@RequestMapping(value = &quot;/api/monkeytypes/&quot;, method = RequestMethod.GET, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; listAllMonkeyTypes() {
<span class="fc" id="L155">		return new ResponseEntity&lt;&gt;(Arrays.asList(MonkeyType.values()), HttpStatus.OK);</span>
	}

	/**
	 * This API returns Single Monkey Strategy object for given Monkey Strategy
	 * id
	 * 
	 * @param request
	 * @param id
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns single Monkey Strategy Object present in Elastic Search for given Monkey Strategy ID&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned single Monkey Strategy Object for given Monkey Strategy ID&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given Monkey Strategy ID&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/{id}&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;Object&gt; getMonkeyStrategy(HttpServletRequest request, @PathVariable(&quot;id&quot;) String id) {
<span class="fc" id="L173">		logger.debug(&quot;Fetching monkeyStrategy with id : %s &quot;, id);</span>

<span class="fc" id="L175">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L176">		MonkeyStrategy monkeyStrategy = monkeyStrategyService.findOneForTeam(id, teamName);</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L179">			final String error = &quot;MonkeyStrategy not found for id &quot; + id;</span>
<span class="fc" id="L180">			logger.debug(error);</span>
<span class="fc" id="L181">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L182">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L184">		return new ResponseEntity&lt;&gt;(monkeyStrategy, HttpStatus.OK);</span>
	}

	/**
	 * This API returns Single Monkey Strategy object for given Monkey Strategy
	 * Name
	 * 
	 * @param request
	 * @param name
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns single Monkey Strategy Object present in Elastic Search for given Monkey Strategy Name&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned Monkey Strategy Object for given Monkey Strategy Name&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given Monkey Strategy Name&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/monkeystrategybyname/{name}&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;Object&gt; getMonkeyStrategyByName(HttpServletRequest request,
			@PathVariable(&quot;name&quot;) String name) {
<span class="fc" id="L203">		logger.debug(&quot;Fetching monkeyStrategy with name : %s&quot;, name);</span>
<span class="fc" id="L204">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L205">		MonkeyStrategy monkeyStrategy = monkeyStrategyService.findByMonkeyStrategyNameAndTeamName(name, teamName);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L207">			final String error = &quot;Monkey Strategy not found for Team : &quot; + name + &quot;, &quot; + teamName;</span>
<span class="fc" id="L208">			logger.debug(error);</span>
<span class="fc" id="L209">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L210">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L212">		return new ResponseEntity&lt;&gt;(monkeyStrategy, HttpStatus.OK);</span>
	}

	/**
	 * This API returns default Monkey Strategy for given Monkey Strategy Name
	 * and MonkeyType
	 * 
	 * @param request
	 * @param name
	 * @param monkeyTypeStr
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns single Default Monkey Strategy Object present in Elastic Search for given Monkey Strategy Name &amp; Monkey Type&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned Monkey Strategy Object for given Monkey Strategy Name &amp; Monkey Type&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given Monkey Strategy Name &amp; Monkey Type&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/defaultmonkeystrategy/{name}/{monkeytype}&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;Object&gt; getDefaultMonkeyStrategy(HttpServletRequest request,
			@PathVariable(&quot;name&quot;) String name, @PathVariable(&quot;monkeytype&quot;) String monkeyTypeStr) {

<span class="fc" id="L233">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L234">		MonkeyType monkeyType = MonkeyType.fromString(monkeyTypeStr.trim());</span>

<span class="fc" id="L236">		MonkeyStrategy monkeyStrategy = monkeyStrategyService.findDefaultMonkeyStrategy(name, monkeyType, teamName);</span>
<span class="fc bfc" id="L237" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L238">			final String error = &quot;Default Monkey Strategy not found with name &amp; monkeyType : &quot; + name + &quot; ,&quot;</span>
					+ monkeyType + &quot; for Team &quot; + teamName;
<span class="fc" id="L240">			logger.debug(error);</span>
<span class="fc" id="L241">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L242">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L244">		return new ResponseEntity&lt;&gt;(monkeyStrategy, HttpStatus.OK);</span>
	}

	/**
	 * This API returns Single monkeyStrategy by Name and Version
	 * 
	 * @param request
	 * @param name
	 * @param version
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns single Default Monkey Strategy Object present in Elastic Search for given Monkey Strategy Name &amp; Version&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned Monkey Strategy Object for given Monkey Strategy Name &amp; Version&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given Monkey Strategy Name &amp; Version&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/{name}/{version}/&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;Object&gt; getMonkeyStrategyByNameAndVersion(HttpServletRequest request,
			@PathVariable(&quot;name&quot;) String name, @PathVariable(&quot;version&quot;) String version) {
<span class="fc" id="L263">		logger.debug(&quot;Fetching monkeyStrategy : %s and version: %s&quot;, name, version);</span>

<span class="fc" id="L265">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L266">		MonkeyStrategy monkeyStrategy = monkeyStrategyService.findByMonkeyStrategyNameAndTeamNameAndVersion(name,</span>
				teamName, version);
<span class="fc bfc" id="L268" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L269">			final String error = &quot;monkeyStrategy &quot; + name + &quot; and verion &quot; + version + &quot; not found &quot; + &quot; for Team &quot;</span>
					+ teamName;
<span class="fc" id="L271">			logger.debug(error);</span>
<span class="fc" id="L272">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L273">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L275">		return new ResponseEntity&lt;&gt;(monkeyStrategy, HttpStatus.OK);</span>
	}

	/**
	 * This API returns count of Monkey Strategies
	 * 
	 * @param request
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns count of Monkey Strategy objects available in Elastic Search for a team&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned count of Monkey Strategy objects for given team&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;The resource trying to reach is not found&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/count/&quot;, method = RequestMethod.GET, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; countByTeamName(HttpServletRequest request) {
<span class="fc" id="L291">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L292">		Long count = monkeyStrategyService.countByTeamName(teamName);</span>
<span class="fc" id="L293">		return new ResponseEntity&lt;&gt;(count.toString(), HttpStatus.OK);</span>
	}

	/**
	 * This API returns all Monkey Strategies by given Application and
	 * Application Environment
	 * 
	 * @param request
	 * @param applicationname
	 * @param environmentname
	 * @return
	 */
	@ApiOperation(value = &quot;This API returns Monkey Strategy Objects present in Elastic Search for given App Emvironment and team name&quot;, response = ResponseEntity.class)
	@ApiResponses(value = {
			@ApiResponse(code = 200, message = &quot;Returned Monkey Strategy Object for given App Emvironment and team name&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to view requested object&quot;),
			@ApiResponse(code = 404, message = &quot;No Monkey Strategy object found for given App Emvironment and team name&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/autodiscover/{applicationname}/{environmentname}&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public ResponseEntity&lt;Object&gt; getFailurePointByApplicationEnvironmentAndTeamName(HttpServletRequest request,
			@PathVariable(&quot;applicationname&quot;) String applicationname,
			@PathVariable(&quot;environmentname&quot;) String environmentname) {
<span class="fc" id="L314">		logger.debug(&quot;Fetching Monkey Strategies for application: %s , and environment : %s&quot;, applicationname,</span>
				environmentname);

<span class="fc" id="L317">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L318">		Application application = applicationService.findByApplicationNameAndTeamName(applicationname, teamName);</span>

<span class="fc bfc" id="L320" title="All 2 branches covered.">		if (application == null) {</span>
<span class="fc" id="L321">			final String error = &quot; Application Not found for name &quot; + applicationname;</span>
<span class="fc" id="L322">			logger.debug(error);</span>
<span class="fc" id="L323">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L324">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc bfc" id="L327" title="All 2 branches covered.">		if (application.getEnvironment(environmentname) == null) {</span>
<span class="fc" id="L328">			final String error = &quot;Environment &quot; + environmentname + &quot; not found for application with name &quot;</span>
					+ applicationname;
<span class="fc" id="L330">			logger.debug(error);</span>
<span class="fc" id="L331">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L332">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc" id="L335">		HashMap&lt;String, List&lt;FailurePoint&gt;&gt; serverFailurePointMap = (HashMap&lt;String, List&lt;FailurePoint&gt;&gt;) monkeyStrategyService</span>
<span class="fc" id="L336">				.findMonkeyStrategyByOSTypeAndProcessName(application.getCategory(),</span>
<span class="fc" id="L337">						application.getEnvironment(environmentname).getServerList());</span>

<span class="pc bpc" id="L339" title="1 of 4 branches missed.">		if (serverFailurePointMap == null || serverFailurePointMap.isEmpty()) {</span>
<span class="fc" id="L340">			final String error = &quot;No Monkey Strategy found for applicationname &quot; + applicationname + &quot;and environment &quot;</span>
					+ environmentname;
<span class="fc" id="L342">			logger.debug(error);</span>
<span class="fc" id="L343">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L344">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L346">		return new ResponseEntity&lt;&gt;(serverFailurePointMap, HttpStatus.OK);</span>
	}

	/**
	 * This API creates a Monkey Strategy
	 * 
	 * @param request
	 * @param monkeyStrategy
	 * @param ucBuilder
	 * @return
	 */
	@ApiOperation(value = &quot;This API inserts a Monkey Strategy Object into Elastic Search&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 201, message = &quot;Monkey Strategy object successfully inserted into ES&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to perform Add operation&quot;),
			@ApiResponse(code = 409, message = &quot;Monkey Strategy with same name is already exist&quot;),
			@ApiResponse(code = 404, message = &quot;The resource trying to reach is not found&quot;),
			@ApiResponse(code = 400, message = &quot;Input Request object is not valid&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategy/&quot;, method = RequestMethod.POST, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; addMonkeyStrategy(HttpServletRequest request,
			@RequestBody MonkeyStrategy monkeyStrategy, UriComponentsBuilder ucBuilder) {

<span class="fc bfc" id="L367" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L368">			final String error = &quot;NULL request received to add monkeyStrategy&quot;;</span>
<span class="fc" id="L369">			logger.debug(error);</span>
<span class="fc" id="L370">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.BAD_REQUEST, error, error);</span>
<span class="fc" id="L371">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="pc bpc" id="L374" title="1 of 2 branches missed.">		if (monkeyStrategy.getMonkeyStrategyName() == null</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">				|| &quot;&quot;.equals(monkeyStrategy.getMonkeyStrategyName().trim())) {</span>
<span class="fc" id="L376">			final String error = &quot;Monkey Strategy name is empty&quot;;</span>
<span class="fc" id="L377">			logger.debug(error);</span>
<span class="fc" id="L378">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.BAD_REQUEST, error, error);</span>
<span class="fc" id="L379">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc" id="L382">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L383">		monkeyStrategy.setTeamName(teamName);</span>
<span class="fc" id="L384">		logger.debug(&quot;Creating monkeyStrategy with name --&gt;&quot; + monkeyStrategy.getMonkeyStrategyName());</span>

<span class="fc bfc" id="L386" title="All 2 branches covered.">		if (insertMonkeyStrategy(monkeyStrategy, teamName)) {</span>
<span class="fc" id="L387">			final String error = &quot;MonkeyStrategy with name &quot; + monkeyStrategy.getMonkeyStrategyName()</span>
					+ &quot; already exist&quot;;
<span class="fc" id="L389">			logger.debug(error);</span>
<span class="fc" id="L390">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.CONFLICT, error, error);</span>
<span class="fc" id="L391">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc" id="L394">		logger.debug(&quot;MonkeyStrategy saved in ES with id --&gt;&quot; + monkeyStrategy.getId());</span>
<span class="fc" id="L395">		HttpHeaders headers = new HttpHeaders();</span>
<span class="fc" id="L396">		headers.setLocation(ucBuilder.path(&quot;/monkeyStrategy/{id}&quot;).buildAndExpand(monkeyStrategy.getId()).toUri());</span>
<span class="fc" id="L397">		return new ResponseEntity&lt;&gt;(headers, HttpStatus.CREATED);</span>
	}

	/**
	 * This method inserts a monkey strategy.
	 * 
	 * @param monkeyStrategy
	 * @param teamName
	 * @return
	 */
	private boolean insertMonkeyStrategy(MonkeyStrategy monkeyStrategy, String teamName) {
<span class="fc" id="L408">		if (monkeyStrategyService.findDefaultMonkeyStrategy(monkeyStrategy.getMonkeyType(),</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">				monkeyStrategy.getMonkeyStrategyName(), &quot;Y&quot;, teamName).iterator().hasNext()</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">				&amp;&amp; &quot;Y&quot;.equals(monkeyStrategy.getDefaultFlag().trim())) {</span>
<span class="fc" id="L411">			return true;</span>
		}

<span class="pc bpc" id="L414" title="1 of 2 branches missed.">		return monkeyStrategyService.insertForTeam(monkeyStrategy, teamName) == null;</span>
	}

	/**
	 * This API updates a monkeyStrategy for given Monkey Strategy ID
	 * 
	 * @param request
	 * @param id
	 * @param toModifyMonkeyStrategy
	 * @return
	 */
	@ApiOperation(value = &quot;This API updates a Monkey Strategy Objects into Elastic Search&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;Monkey Strategy object successfully updated into ES&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to perform Update operation&quot;),
			@ApiResponse(code = 409, message = &quot;Monkey Strategy can be changed only by the owning team&quot;),
			@ApiResponse(code = 404, message = &quot;Monkey Strategy object not found in ES for given Monkey Strategy ID&quot;),
			@ApiResponse(code = 400, message = &quot;Input Request object is not valid&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/{id}&quot;, method = RequestMethod.PUT, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; updateMonkeyStrategy(HttpServletRequest request, @PathVariable(&quot;id&quot;) String id,
			@RequestBody MonkeyStrategy toModifyMonkeyStrategy) {
<span class="fc" id="L434">		logger.debug(&quot;Updating monkeyStrategy : %s&quot;, id);</span>

<span class="fc" id="L436">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L437">		MonkeyStrategy currentMonkeyStrategy = monkeyStrategyService.findOneForTeam(id, teamName);</span>

<span class="pc bpc" id="L439" title="1 of 2 branches missed.">		if (!AppUtil.getSuperUser().equalsIgnoreCase(toModifyMonkeyStrategy.getTeamName())</span>
<span class="fc bfc" id="L440" title="All 2 branches covered.">				&amp;&amp; !toModifyMonkeyStrategy.getTeamName().equalsIgnoreCase(teamName)) {</span>

<span class="fc" id="L442">			final String error = &quot;MonkeyStrategy can be changed only by the owning Team:&quot;</span>
<span class="fc" id="L443">					+ toModifyMonkeyStrategy.getTeamName();</span>
<span class="fc" id="L444">			logger.debug(error);</span>
<span class="fc" id="L445">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.CONFLICT, error, error);</span>
<span class="fc" id="L446">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc bfc" id="L449" title="All 2 branches covered.">		if (currentMonkeyStrategy == null) {</span>
<span class="fc" id="L450">			final String error = &quot;MonkeyStrategy with id &quot; + id + &quot; not found&quot;;</span>
<span class="fc" id="L451">			logger.debug(error);</span>
<span class="fc" id="L452">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L453">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc bfc" id="L456" title="All 2 branches covered.">		if (isDefaultStrategyExist(toModifyMonkeyStrategy, teamName)) {</span>
<span class="fc" id="L457">			final String error = &quot;Default monkeyStrategy with name &quot; + toModifyMonkeyStrategy.getMonkeyStrategyName()</span>
					+ &quot; already exist.&quot;;
<span class="fc" id="L459">			logger.debug(error);</span>
<span class="fc" id="L460">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.CONFLICT, error, error);</span>
<span class="fc" id="L461">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="fc" id="L464">		toModifyMonkeyStrategy.setId(id);</span>
<span class="fc" id="L465">		toModifyMonkeyStrategy.setTeamName(teamName);</span>
<span class="fc" id="L466">		monkeyStrategyService.update(toModifyMonkeyStrategy);</span>
<span class="fc" id="L467">		return new ResponseEntity&lt;&gt;(toModifyMonkeyStrategy, HttpStatus.OK);</span>
	}

	/**
	 * This method checks for Default monkey strategy.
	 * 
	 * @param toModifyMonkeyStrategy
	 * @param teamName
	 * @return
	 */
	private boolean isDefaultStrategyExist(MonkeyStrategy toModifyMonkeyStrategy, String teamName) {
<span class="fc bfc" id="L478" title="All 2 branches covered.">		if (&quot;Y&quot;.equalsIgnoreCase(toModifyMonkeyStrategy.getDefaultFlag())) {</span>
<span class="fc" id="L479">			Iterable&lt;MonkeyStrategy&gt; iterable = monkeyStrategyService.findDefaultMonkeyStrategy(</span>
<span class="fc" id="L480">					toModifyMonkeyStrategy.getMonkeyType(), toModifyMonkeyStrategy.getMonkeyStrategyName(), &quot;Y&quot;,</span>
					teamName);
<span class="fc" id="L482">			MonkeyStrategy defaultMonkeyStrategy = null;</span>
<span class="pc bpc" id="L483" title="2 of 4 branches missed.">			if (null != iterable &amp;&amp; null != iterable.iterator()) {</span>
<span class="pc bpc" id="L484" title="1 of 2 branches missed.">				for (Iterator&lt;MonkeyStrategy&gt; it = iterable.iterator(); it.hasNext();) {</span>
<span class="fc" id="L485">					defaultMonkeyStrategy = it.next();</span>
					break;
				}
			}
<span class="pc bpc" id="L489" title="1 of 2 branches missed.">			if (null != defaultMonkeyStrategy</span>
<span class="pc bpc" id="L490" title="1 of 2 branches missed.">					&amp;&amp; !defaultMonkeyStrategy.getId().equals(toModifyMonkeyStrategy.getId())) {</span>
<span class="fc" id="L491">				return true;</span>
			}
		}
<span class="fc" id="L494">		return false;</span>
	}

	/**
	 * This API deletes a MonkeyStrategy
	 * 
	 * @param request
	 * @param id
	 * @return
	 */
	@ApiOperation(value = &quot;This API deletes a Monkey Strategy Objects from Elastic Search&quot;, response = ResponseEntity.class)
	@ApiResponses(value = { @ApiResponse(code = 200, message = &quot;Monkey Strategy object successfully deleted from ES&quot;),
			@ApiResponse(code = 401, message = &quot;User is not authorized to perform Delete operation&quot;),
			@ApiResponse(code = 409, message = &quot;Monkey Strategy can be delted only by the owning team&quot;),
			@ApiResponse(code = 404, message = &quot;Monkey Strategy object not found in ES for given Monkey Strategy ID&quot;),
			@ApiResponse(code = 400, message = &quot;Input Request object is not valid&quot;) })
	@RequestMapping(value = &quot;/api/monkeystrategies/{id}&quot;, method = RequestMethod.DELETE, produces = &quot;application/json&quot;)
	public ResponseEntity&lt;Object&gt; deletemonkeystrategy(HttpServletRequest request, @PathVariable(&quot;id&quot;) String id) {
<span class="fc" id="L512">		logger.debug(&quot;Deleting monkeystrategy with id %s&quot;, id);</span>

<span class="fc" id="L514">		final String teamName = userDetailsService.getCurrentTeamForUser(request).getTeamName();</span>
<span class="fc" id="L515">		MonkeyStrategy monkeyStrategy = monkeyStrategyService.findOneForTeam(id, teamName);</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">		if (monkeyStrategy == null) {</span>
<span class="fc" id="L517">			final String error = &quot;Unable to delete as Monkeystrategy with id: &quot; + id + &quot; not found&quot;;</span>
<span class="fc" id="L518">			logger.debug(error);</span>
<span class="fc" id="L519">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.NOT_FOUND, error, error);</span>
<span class="fc" id="L520">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}

<span class="pc bpc" id="L523" title="1 of 2 branches missed.">		if (!AppUtil.getSuperUser().equalsIgnoreCase(monkeyStrategy.getTeamName())</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">				&amp;&amp; !monkeyStrategy.getTeamName().equalsIgnoreCase(teamName)) {</span>
<span class="nc" id="L525">			final String error = &quot;MonkeyStrategy can be deleted only by the owning Team &quot;</span>
<span class="nc" id="L526">					+ monkeyStrategy.getTeamName();</span>
<span class="nc" id="L527">			logger.debug(error);</span>
<span class="nc" id="L528">			final MessageWrapper apiError = new MessageWrapper(HttpStatus.CONFLICT, error, error);</span>
<span class="nc" id="L529">			return new ResponseEntity&lt;&gt;(apiError, new HttpHeaders(), apiError.getStatus());</span>
		}
<span class="fc" id="L531">		monkeyStrategyService.delete(monkeyStrategy);</span>
<span class="fc" id="L532">		return new ResponseEntity&lt;&gt;(HttpStatus.OK);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>